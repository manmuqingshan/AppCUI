name: build-and-deploy-release

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            lib_ext: lib
            bin_path: D:/a/AppCUI/AppCUI/bin
            vcpkg_triplet: x64-windows
            archive_tool: 7z
          - os: ubuntu-22.04
            lib_ext: a
            bin_path: /home/runner/work/AppCUI/AppCUI/bin
            vcpkg_triplet: x64-linux
            archive_tool: zip
          - os: macos-15-intel
            lib_ext: a
            bin_path: /Users/runner/work/AppCUI/AppCUI/bin
            vcpkg_triplet: x64-osx
            archive_tool: zip

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install dependencies
      - name: Install dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential cmake zip libx11-dev

      - name: Install dependencies (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew update
          brew install cmake pkg-config zip

      - name: Install dependencies (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          choco install cmake ninja 7zip -y --no-progress

      # Configure + build
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $output = python .github/workflows/get_version.py AppCUI/include/AppCUI.hpp
          echo "APPCUI_VERSION=$output" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "version=$output" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # Copy static libs and terminfo if available
      - name: Copy libraries
        run: |
          mkdir -p "${{ matrix.bin_path }}"
          if [ -d "build/vcpkg_installed/${{ matrix.vcpkg_triplet }}/lib" ]; then
            cp -R build/vcpkg_installed/${{ matrix.vcpkg_triplet }}/lib/*.${{ matrix.lib_ext }} "${{ matrix.bin_path }}/" || true
          fi
          if [ -d "build/vcpkg_installed/${{ matrix.vcpkg_triplet }}/share/terminfo" ]; then
            cp -R build/vcpkg_installed/${{ matrix.vcpkg_triplet }}/share/terminfo "${{ matrix.bin_path }}/" || true
          fi
        shell: bash

      # List artifacts
      - name: List build outputs
        run: ls -R "${{ matrix.bin_path }}"
        shell: bash

      # Create archive
      - name: Package build
        shell: bash
        run: |
          cd "${{ matrix.bin_path }}"
          zipname="AppCUI-${{ runner.os }}-${{ runner.arch }}-${{ env.APPCUI_VERSION }}.zip"
          if [ "${{ matrix.archive_tool }}" = "7z" ]; then
            7z a "$zipname" . > NUL
          else
            zip -9 -r "$zipname" .
          fi
          echo "Created $zipname"

      # Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}_artifacts
          path: "${{ matrix.bin_path }}/AppCUI-${{ runner.os }}-${{ runner.arch }}-${{ env.APPCUI_VERSION }}.zip"
          retention-days: 1

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - uses: actions/checkout@v4

      - name: Extract version again
        id: version
        run: |
          output=$(python .github/workflows/get_version.py AppCUI/include/AppCUI.hpp)
          echo "version=$output" >> $GITHUB_OUTPUT
          echo "APPCUI_VERSION=$output" >> $GITHUB_ENV

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Build ${{ steps.version.outputs.version }}
          draft: false
          prerelease: true
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
